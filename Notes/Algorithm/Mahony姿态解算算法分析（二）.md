在[Mahony姿态解算算法笔记（一）](https://www.cnblogs.com/HongxiWong/p/12357230.html)中，我们介绍了融合加速度计与陀螺仪共六轴数据的姿态解算算法，该篇将介绍融合加速度计、陀螺仪和磁力计共九轴数据的姿态解算算法。

该算法可到其网站下载源码https://x-io.co.uk/open-source-imu-and-ahrs-algorithms/

由于笔者水平有限，文中难免存在一些不足和错误之处，诚请各位批评指正。

# 1 引入磁力计数据的原因

在六轴数据融合姿态解算算法中，我们通过理论和实际重力加速度向量来补偿陀螺仪误差，这种方法存在的一个问题就在**重力加速度向量垂直于大地坐标系的$xoy$平面**，因此在飞机水平时，重力加速度无法反应机体Yaw轴的角度变化，因此无法很有效的修正Yaw轴的角度数据，因此我们需要引入磁力计数据。由于地球磁场方向在中低纬度地区与地面大致平行，因此通过磁力计数据我们可以有效的修正Yaw轴的角度数据。

但在一部分情况中，复杂的磁场环境会导致九轴数据融合的结果并不会优于六轴数据太多，甚至劣于六轴数据融合的结果，比如Robomaster机器人云台或使用无刷电机的Mini四轴的姿态解算，有相当一部分参赛队会选择融合六轴数据而非九轴数据。原因是云台复杂多变的磁场环境会给磁力计引入很大的噪声，这就导致了有些情况下九轴数据的姿态融合结果并不会比六轴好。

综上所述，具体选择九轴数据还是六轴数据的融合还需要根据具体环境来决定。



# 2 准备工作

在姿态解算过程中，**传感器的数据并非直接输入该算法中**，在使用Mahony算法，我们需要对加速度计和磁力计的数据进行**滤波**（很重要）和**校正**（没那么重要）

## 2.1 传感器滤波

机体的震动会给加速度计数据带来严重的高频噪声。因此，对于加速度计数据的低通滤波是很有必要的。一般情况下，对加速度数据进行低通滤波即可满足控制要求，根据实际情况可灵活选用滤波算法。

## 2.2 传感器校正

由于 $x,y,z$ 三轴的单位存在差异，测量数据的向量顶点会落在椭球面上而非理想状态下的球面上。另外的，加速度计于磁力计测量的数据会存在一定的偏移，这则会导致椭球的中心不一定在原点，这也就是数据的偏移。因此，在对于精度要求高的场合下我们也需要对传感器数据进行校正。

一般来说，加速度计和磁力计的校正，需要求出椭球的**球心**即偏移量，椭球**轴长**，即椭球拟合。具体椭球拟合算法可以参考https://blog.csdn.net/shenshikexmu/article/details/70143455



数据经过以上步骤以后就可以进入Mahony算法中了。



# 3 融合磁力计数据

九轴数据融合于六轴数据融合算法的思路与框架是完全一致的，即九轴数据融合的实现只需在六轴数据融合算法的基础上加入磁力计修正部分即可，简单来说就是添几行代码。

与通过加速度计数据补偿陀螺仪大致相同，**通过磁力计数据和姿态矩阵得到理论磁场向量和实际磁场向量，并通过向量外积得到向量偏差，最后将偏差带入的PI控制器计算补偿值。**

唯一的取别在于标准重力加速度在星球表面任何地方始终固定不变，可直接从地理坐标系变换到机体坐标系，但地磁的大小与方向并非固定不变，因此需要通过测量并转换得到地理坐标系中的磁力向量，然后再将其通过姿态矩阵转换至机体坐标系，从而得到理论磁力向量。